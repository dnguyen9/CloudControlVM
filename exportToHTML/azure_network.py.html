<html>
<head>
<title>azure_network.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: rgb(0,0,0); font-weight: normal; font-style: normal; }
.s0 { color: rgb(128,128,128); font-style: italic; }
.s1 { color: rgb(0,0,0); }
.s2 { color: rgb(0,0,128); font-weight: bold; }
.s3 { color: rgb(0,128,0); font-weight: bold; }
.s4 { color: rgb(0,0,255); }
</style>
</head>
<BODY BGCOLOR="#ffffff">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#C0C0C0" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
azure_network.py</FONT>
</center></TD></TR></TABLE>
<pre>
<span class="s0"># Copyright 2014 PerfKitBenchmarker Authors. All rights reserved.</span><span class="s1"> 
</span><span class="s0">#</span><span class="s1"> 
</span><span class="s0"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><span class="s1"> 
</span><span class="s0"># you may not use this file except in compliance with the License.</span><span class="s1"> 
</span><span class="s0"># You may obtain a copy of the License at</span><span class="s1"> 
</span><span class="s0">#</span><span class="s1"> 
</span><span class="s0">#   http://www.apache.org/licenses/LICENSE-2.0</span><span class="s1"> 
</span><span class="s0">#</span><span class="s1"> 
</span><span class="s0"># Unless required by applicable law or agreed to in writing, software</span><span class="s1"> 
</span><span class="s0"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><span class="s1"> 
</span><span class="s0"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="s1"> 
</span><span class="s0"># See the License for the specific language governing permissions and</span><span class="s1"> 
</span><span class="s0"># limitations under the License.</span><span class="s1"> 
 
</span><span class="s0">&quot;&quot;&quot;Module containing classes related to Azure VM networking. 
 
The Firewall class provides a way of opening VM ports. The Network class allows 
VMs to communicate via internal ips and isolates PerfKitBenchmarker VMs from 
others in 
the same project. See http://msdn.microsoft.com/library/azure/jj156007.aspx 
for more information about Azure Virtual Networks. 
&quot;&quot;&quot;</span><span class="s1"> 
 
</span><span class="s2">import </span><span class="s1">json 
</span><span class="s2">import </span><span class="s1">uuid 
 
</span><span class="s2">from </span><span class="s1">perfkitbenchmarker </span><span class="s2">import </span><span class="s1">flags 
</span><span class="s2">from </span><span class="s1">perfkitbenchmarker </span><span class="s2">import </span><span class="s1">network 
</span><span class="s2">from </span><span class="s1">perfkitbenchmarker </span><span class="s2">import </span><span class="s1">resource 
</span><span class="s2">from </span><span class="s1">perfkitbenchmarker </span><span class="s2">import </span><span class="s1">vm_util 
</span><span class="s2">from </span><span class="s1">perfkitbenchmarker </span><span class="s2">import </span><span class="s1">providers 
 
FLAGS = flags.FLAGS 
AZURE_PATH = </span><span class="s3">'azure'</span><span class="s1"> 
MAX_NAME_LENGTH = </span><span class="s4">24</span><span class="s1"> 
SSH_PORT = </span><span class="s4">22</span><span class="s1"> 
</span><span class="s0"># We need to prefix storage account names so that VMs won't create their own</span><span class="s1"> 
</span><span class="s0"># account upon creation.</span><span class="s1"> 
</span><span class="s0"># See https://github.com/MSOpenTech/azure-xplat-cli/pull/349</span><span class="s1"> 
STORAGE_ACCOUNT_PREFIX = </span><span class="s3">'portalvhds'</span><span class="s1"> 
 
 
</span><span class="s2">class </span><span class="s1">_AzureEndpoint(resource.BaseResource): 
  </span><span class="s0">&quot;&quot;&quot;An object representing an endpoint to an Azure VM. 
 
  No deletion is specified, as endpoints are deleted along with the VM. 
  &quot;&quot;&quot;</span><span class="s1"> 
  </span><span class="s2">def </span><span class="s1">__init__(self, vm_name, port, protocol): 
    super(_AzureEndpoint, self).__init__() 
    self.vm_name = vm_name 
    self.port = port 
    self.protocol = protocol 
 
  </span><span class="s2">def </span><span class="s1">_Create(self): 
    create_cmd = [AZURE_PATH, 
                  </span><span class="s3">'vm'</span><span class="s1">, 
                  </span><span class="s3">'endpoint'</span><span class="s1">, 
                  </span><span class="s3">'create'</span><span class="s1">, 
                  self.vm_name, 
                  str(self.port), 
                  </span><span class="s3">'--protocol=' </span><span class="s1">+ self.protocol] 
    vm_util.IssueCommand(create_cmd) 
 
  </span><span class="s2">def </span><span class="s1">_Exists(self): 
    </span><span class="s0">&quot;&quot;&quot;Returns whether or not an endpoint exists.&quot;&quot;&quot;</span><span class="s1"> 
    </span><span class="s0"># Example output:</span><span class="s1"> 
    </span><span class="s0"># [</span><span class="s1"> 
    </span><span class="s0">#   {</span><span class="s1"> 
    </span><span class="s0">#     &quot;localPort&quot;: 22,</span><span class="s1"> 
    </span><span class="s0">#     &quot;name&quot;: &quot;ssh&quot;,</span><span class="s1"> 
    </span><span class="s0">#     &quot;port&quot;: 22,</span><span class="s1"> 
    </span><span class="s0">#     &quot;protocol&quot;: &quot;tcp&quot;,</span><span class="s1"> 
    </span><span class="s0">#     &quot;virtualIPAddress&quot;: &quot;104.43.224.13&quot;,</span><span class="s1"> 
    </span><span class="s0">#     &quot;enableDirectServerReturn&quot;: false</span><span class="s1"> 
    </span><span class="s0">#   }</span><span class="s1"> 
    </span><span class="s0"># ]</span><span class="s1"> 
    exists_cmd = [AZURE_PATH, 
                  </span><span class="s3">'vm'</span><span class="s1">, 
                  </span><span class="s3">'endpoint'</span><span class="s1">, 
                  </span><span class="s3">'list'</span><span class="s1">, 
                  </span><span class="s3">'--json'</span><span class="s1">, 
                  self.vm_name] 
    stdout, _, status = vm_util.IssueCommand(exists_cmd) 
    </span><span class="s2">if </span><span class="s1">status </span><span class="s2">or </span><span class="s1">stdout == </span><span class="s3">'No VMs found'</span><span class="s1">: 
      </span><span class="s2">return </span><span class="s1">False 
    </span><span class="s2">else</span><span class="s1">: 
      arr = json.loads(stdout) 
      </span><span class="s2">return </span><span class="s1">any(ep[</span><span class="s3">'port'</span><span class="s1">] == self.port </span><span class="s2">and </span><span class="s1">ep[</span><span class="s3">'protocol'</span><span class="s1">] == self.protocol 
                 </span><span class="s2">for </span><span class="s1">ep </span><span class="s2">in </span><span class="s1">arr) 
 
  </span><span class="s2">def </span><span class="s1">_Delete(self): 
    </span><span class="s0">&quot;&quot;&quot;Endpoint will be deleted with VM, so this is a noop.&quot;&quot;&quot;</span><span class="s1"> 
    </span><span class="s2">pass</span><span class="s1"> 
 
 
</span><span class="s2">class </span><span class="s1">AzureFirewall(network.BaseFirewall): 
  </span><span class="s0">&quot;&quot;&quot;An object representing the Azure Firewall equivalent. 
 
  On Azure, endpoints are used to open ports instead of firewalls. 
  &quot;&quot;&quot;</span><span class="s1"> 
 
  CLOUD = providers.AZURE 
 
  </span><span class="s2">def </span><span class="s1">AllowPort(self, vm, port): 
    </span><span class="s0">&quot;&quot;&quot;Opens a port on the firewall. 
 
    Args: 
      vm: The BaseVirtualMachine object to open the port for. 
      port: The local port to open. 
    &quot;&quot;&quot;</span><span class="s1"> 
    </span><span class="s2">if </span><span class="s1">vm.is_static </span><span class="s2">or </span><span class="s1">port == SSH_PORT: 
      </span><span class="s2">return</span><span class="s1"> 
    _AzureEndpoint(vm.name, port, </span><span class="s3">'tcp'</span><span class="s1">).Create() 
    _AzureEndpoint(vm.name, port, </span><span class="s3">'udp'</span><span class="s1">).Create() 
 
  </span><span class="s2">def </span><span class="s1">DisallowAllPorts(self): 
    </span><span class="s0">&quot;&quot;&quot;Closes all ports on the firewall.&quot;&quot;&quot;</span><span class="s1"> 
    </span><span class="s2">pass</span><span class="s1"> 
 
 
</span><span class="s2">class </span><span class="s1">AzureStorageAccount(resource.BaseResource): 
  </span><span class="s0">&quot;&quot;&quot;Object representing an Azure Storage Account.&quot;&quot;&quot;</span><span class="s1"> 
 
  </span><span class="s2">def </span><span class="s1">__init__(self, name, storage_type, zone): 
    super(AzureStorageAccount, self).__init__() 
    self.name = name 
    self.storage_type = storage_type 
    self.zone = zone 
 
  </span><span class="s2">def </span><span class="s1">_Create(self): 
    </span><span class="s0">&quot;&quot;&quot;Creates the storage account.&quot;&quot;&quot;</span><span class="s1"> 
    create_cmd = [AZURE_PATH, 
                  </span><span class="s3">'storage'</span><span class="s1">, 
                  </span><span class="s3">'account'</span><span class="s1">, 
                  </span><span class="s3">'create'</span><span class="s1">, 
                  </span><span class="s3">'--location=%s' </span><span class="s1">% self.zone, 
                  </span><span class="s3">'--type=%s' </span><span class="s1">% self.storage_type, 
                  self.name] 
    vm_util.IssueCommand(create_cmd) 
 
  </span><span class="s2">def </span><span class="s1">_Delete(self): 
    </span><span class="s0">&quot;&quot;&quot;Deletes the storage account.&quot;&quot;&quot;</span><span class="s1"> 
    delete_cmd = [AZURE_PATH, 
                  </span><span class="s3">'storage'</span><span class="s1">, 
                  </span><span class="s3">'account'</span><span class="s1">, 
                  </span><span class="s3">'delete'</span><span class="s1">, 
                  </span><span class="s3">'--quiet'</span><span class="s1">, 
                  self.name] 
    vm_util.IssueCommand(delete_cmd) 
 
  </span><span class="s2">def </span><span class="s1">_Exists(self): 
    </span><span class="s0">&quot;&quot;&quot;Returns true if the storage account exists.&quot;&quot;&quot;</span><span class="s1"> 
    show_cmd = [AZURE_PATH, 
                </span><span class="s3">'storage'</span><span class="s1">, 
                </span><span class="s3">'account'</span><span class="s1">, 
                </span><span class="s3">'show'</span><span class="s1">, 
                </span><span class="s3">'--json'</span><span class="s1">, 
                self.name] 
    stdout, _, _ = vm_util.IssueCommand(show_cmd, suppress_warning=True) 
    </span><span class="s2">try</span><span class="s1">: 
      json.loads(stdout) 
    </span><span class="s2">except </span><span class="s1">ValueError: 
      </span><span class="s2">return </span><span class="s1">False 
    </span><span class="s2">return </span><span class="s1">True 
 
 
</span><span class="s2">class </span><span class="s1">AzureVirtualNetwork(resource.BaseResource): 
  </span><span class="s0">&quot;&quot;&quot;Object representing an Azure Virtual Network.&quot;&quot;&quot;</span><span class="s1"> 
 
  </span><span class="s2">def </span><span class="s1">__init__(self, name, zone): 
    super(AzureVirtualNetwork, self).__init__() 
    self.name = name 
    self.zone = zone 
 
  </span><span class="s2">def </span><span class="s1">_Create(self): 
    </span><span class="s0">&quot;&quot;&quot;Creates the virtual network.&quot;&quot;&quot;</span><span class="s1"> 
    create_cmd = [AZURE_PATH, 
                  </span><span class="s3">'network'</span><span class="s1">, 
                  </span><span class="s3">'vnet'</span><span class="s1">, 
                  </span><span class="s3">'create'</span><span class="s1">, 
                  </span><span class="s3">'--location'</span><span class="s1">, self.zone, 
                  self.name] 
    vm_util.IssueCommand(create_cmd) 
 
  </span><span class="s2">def </span><span class="s1">_Delete(self): 
    </span><span class="s0">&quot;&quot;&quot;Deletes the virtual network.&quot;&quot;&quot;</span><span class="s1"> 
    delete_cmd = [AZURE_PATH, 
                  </span><span class="s3">'network'</span><span class="s1">, 
                  </span><span class="s3">'vnet'</span><span class="s1">, 
                  </span><span class="s3">'delete'</span><span class="s1">, 
                  </span><span class="s3">'--quiet'</span><span class="s1">, 
                  self.name] 
    vm_util.IssueCommand(delete_cmd) 
 
  </span><span class="s2">def </span><span class="s1">_Exists(self): 
    </span><span class="s0">&quot;&quot;&quot;Returns true if the virtual network exists.&quot;&quot;&quot;</span><span class="s1"> 
    show_cmd = [AZURE_PATH, 
                </span><span class="s3">'network'</span><span class="s1">, 
                </span><span class="s3">'vnet'</span><span class="s1">, 
                </span><span class="s3">'show'</span><span class="s1">, 
                </span><span class="s3">'--json'</span><span class="s1">, 
                self.name] 
    stdout, _, _ = vm_util.IssueCommand(show_cmd, suppress_warning=True) 
    vnet = json.loads(stdout) 
    </span><span class="s2">if </span><span class="s1">vnet: 
      </span><span class="s2">return </span><span class="s1">True 
    </span><span class="s2">return </span><span class="s1">False 
 
 
</span><span class="s2">class </span><span class="s1">AzureNetwork(network.BaseNetwork): 
  </span><span class="s0">&quot;&quot;&quot;Object representing an Azure Network.&quot;&quot;&quot;</span><span class="s1"> 
 
  CLOUD = providers.AZURE 
 
  </span><span class="s2">def </span><span class="s1">__init__(self, spec): 
    super(AzureNetwork, self).__init__(spec) 
    name = (</span><span class="s3">'pkb%s%s' </span><span class="s1">% 
            (FLAGS.run_uri, str(uuid.uuid4())[-</span><span class="s4">12</span><span class="s1">:])).lower()[:MAX_NAME_LENGTH] 
    storage_account_name = (STORAGE_ACCOUNT_PREFIX + name)[:MAX_NAME_LENGTH] 
    self.storage_account = AzureStorageAccount( 
        storage_account_name, FLAGS.azure_storage_type, self.zone) 
    self.vnet = AzureVirtualNetwork(name, self.zone) 
 
  @vm_util.Retry() 
  </span><span class="s2">def </span><span class="s1">Create(self): 
    </span><span class="s0">&quot;&quot;&quot;Creates the actual network.&quot;&quot;&quot;</span><span class="s1"> 
    self.storage_account.Create() 
    self.vnet.Create() 
 
  </span><span class="s2">def </span><span class="s1">Delete(self): 
    </span><span class="s0">&quot;&quot;&quot;Deletes the actual network.&quot;&quot;&quot;</span><span class="s1"> 
    self.vnet.Delete() 
    self.storage_account.Delete() 
</span></pre>
</body>
</html>